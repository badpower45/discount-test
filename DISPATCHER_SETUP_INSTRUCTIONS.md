# تعليمات إعداد نظام الموزع (Dispatcher System Setup)

## نظرة عامة
تم إضافة نظام موزع احترافي لإدارة تعيين الطلبات للسائقين وتقييم أدائهم.

## خطوات التفعيل

### 1. تحديث قاعدة البيانات Supabase

يجب تشغيل السكريبت التالي في محرر SQL في لوحة تحكم Supabase:

```bash
افتح ملف: dispatcher-system-updates.sql
انسخ المحتوى بالكامل
افتح Supabase Dashboard > SQL Editor
الصق السكريبت وقم بتشغيله
```

سيقوم هذا السكريبت بـ:
- ✅ إضافة دور 'dispatcher' إلى جدول merchants
- ✅ إضافة حالة 'en_route_to_restaurant' للطلبات
- ✅ إضافة حقل customer_location لجدول orders
- ✅ إضافة حقل auth_user_id لجدول delivery_drivers
- ✅ إنشاء 6 وظائف RPC جديدة للموزع
- ✅ إضافة فهارس للأداء الأفضل

### 2. إنشاء مستخدم موزع

بعد تشغيل السكريبت، يمكنك إنشاء مستخدم موزع:

```sql
-- في Supabase SQL Editor
INSERT INTO merchants (name, email, role, auth_user_id)
VALUES (
  'اسم الموزع',
  'dispatcher@example.com',
  'dispatcher',
  NULL -- سيتم تعيين auth_user_id عند تسجيل الدخول
);
```

### 3. الوصول إلى لوحة الموزع

- الرابط: `/dispatcher`
- يتطلب تسجيل دخول بحساب له دور 'dispatcher' أو 'admin'

## الميزات المتاحة

### لوحة تحكم الموزع
1. **عرض الطلبات الجاهزة**: جميع الطلبات بحالة `ready_for_pickup`
2. **عرض السائقين المتاحين**: السائقين بحالة `available`
3. **تعيين الطلبات**: اختر طلب + اختر سائق = تعيين تلقائي
4. **تقييم السائقين**: نظام تقييم من 1 إلى 5 نجوم
5. **إحصائيات حية**: طلبات جاهزة، سائقين متاحين، طلبات نشطة

### لوحة تحكم السائق المحدثة
1. **خريطة التوصيل**: عرض موقع المطعم والعميل
2. **حالات تفصيلية**:
   - في طريقي للمطعم
   - استلمت الطلب من المطعم
   - في طريقي للعميل
   - تم التسليم
3. **شريط تقدم مرئي**: يوضح المرحلة الحالية من التوصيل

## دورة الطلب الكاملة

```
عميل يطلب
    ↓
تاجر يؤكد ويحضّر
    ↓
تاجر: "جاهز للتوصيل" → ready_for_pickup
    ↓
موزع يعيّن سائق → en_route_to_restaurant
    ↓
سائق: "استلمت الطلب" → picked_up
    ↓
سائق: "في طريقي للعميل" → in_transit
    ↓
سائق: "تم التسليم" → delivered
    ↓
موزع يقيّم السائق (اختياري)
```

## وظائف قاعدة البيانات الجديدة

### 1. assign_order_to_driver_by_dispatcher(order_id, driver_id)
- يعين طلب لسائق محدد
- يتحقق من توفر السائق
- يحدّث حالة الطلب إلى `en_route_to_restaurant`
- يحدّث حالة السائق إلى `busy`

### 2. rate_driver_by_dispatcher(driver_id, rating)
- يقيّم أداء السائق (1-5)
- يحسب المتوسط التراكمي للتقييمات
- يزيد عداد التوصيلات

### 3. fetch_ready_orders_for_dispatcher()
- يعرض جميع الطلبات بحالة `ready_for_pickup`
- يشمل معلومات المطعم والعميل

### 4. fetch_available_drivers()
- يعرض جميع السائقين المتاحين
- مرتبة حسب التقييم والأداء

### 5. fetch_my_driver_orders()
- للسائقين فقط: يعرض طلباتهم المخصصة

## ملاحظات مهمة

⚠️ **يجب تشغيل السكريبت في Supabase**: الملف `dispatcher-system-updates.sql` ضروري لتفعيل النظام

✅ **نظام آمن**: جميع الوظائف محمية بالصلاحيات المناسبة

📍 **مواقع افتراضية**: يمكن تحديث إحداثيات المطاعم في الكود حسب الحاجة

🗺️ **الخرائط**: تستخدم OpenStreetMap (مجانية ولا تحتاج API key)

## الاستكشاف والتطوير

- يمكن إضافة تتبع موقع السائق الحالي لاحقاً باستخدام `navigator.geolocation`
- يمكن إضافة إشعارات فورية عند تعيين طلبات جديدة
- يمكن إضافة تقارير أداء السائقين
